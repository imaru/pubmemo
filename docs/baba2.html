<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="pandoc" />

        <meta name="author" content="Toshihide Imaruoka" />
    
    
    <title>馬場本</title>

        <script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
        <script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="site_libs/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet" />
        <script src="site_libs/bootstrap-3.3.7/js/bootstrap.min.js"></script>
        <script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
        <script src="site_libs/navigation-1.1/tabsets.js"></script>
        <link href="site_libs/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
        <script src="site_libs/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
        <link href="site_libs/downcute-0.1/downcute.css" rel="stylesheet" />
        <link href="site_libs/downcute-0.1/downcute_fonts_embed.css" rel="stylesheet" />
        <script src="site_libs/downcute-0.1/downcute_styles.js"></script>
        <script src="site_libs/downcute-0.1/downcute.js"></script>
        <script src="site_libs/prism-1.22/prism.js"></script>
    
    
    
        <link rel="stylesheet" href="mycss.css" type="text/css" />
    
    <!-- tabsets -->
    <script>
      $(document).ready(function () {
	  window.buildTabsets("toc");
      });
      $(document).ready(function () {
	  $('.tabset-dropdown > .nav-tabs > li').click(function () {
	      $(this).parent().toggleClass('nav-tabs-open')
	  });
      });
    </script>

    <!-- code folding -->
    
    <!-- code download -->
    
    <!-- tabsets dropdown -->

    <style type="text/css">
      .tabset-dropdown > .nav-tabs {
	  display: inline-table;
	  max-height: 500px;
	  min-height: 44px;
	  overflow-y: auto;
	  background: white;
	  border: 1px solid #ddd;
	  border-radius: 4px;
      }
      
      .tabset-dropdown > .nav-tabs > li.active:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
	  content: "&#xe258;";
	  border: none;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs > li.active {
	  display: block;
      }

      .tabset-dropdown > .nav-tabs > li.active a {
  	  padding: 0 15px !important;
      }

      .tabset-dropdown > .nav-tabs > li > a,
      .tabset-dropdown > .nav-tabs > li > a:focus,
      .tabset-dropdown > .nav-tabs > li > a:hover {
	  border: none;
	  display: inline-block;
	  border-radius: 4px;
	  background-color: transparent;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li {
	  display: block;
	  float: none;
      }
      
      .tabset-dropdown > .nav-tabs > li {
	  display: none;
	  margin-left: 0 !important;
      }
    </style>
    
</head>

<body class="preload">

   	
               <!-- downcute start -->   
   <div id="docute" class="Root theme-default">
     <div class="Page layout-narrow">
      <div class="Wrap">
        <div class="Sidebar">
          <div class="SidebarItems" id="toc">
            <ul>
            <li><a href="#章">2章</a></li>
            <li><a href="#章rの基本">2-1章：Rの基本</a>
            <ul>
            <li><a href="#目的と概要">1. 目的と概要</a></li>
            <li><a href="#rのインストール">2. Rのインストール</a></li>
            <li><a href="#rstudioのインストール">3. RStudioのインストール</a></li>
            <li><a href="#rstudioの使い方">4. RStudioの使い方</a></li>
            <li><a href="#変数">5. 変数</a></li>
            <li><a href="#関数">6. 関数</a></li>
            <li><a href="#ベクトル">7. ベクトル</a></li>
            <li><a href="#行列">8. 行列</a></li>
            <li><a href="#配列">9. 配列</a></li>
            <li><a href="#データフレーム">10. データフレーム</a></li>
            <li><a href="#リスト">11. リスト</a></li>
            <li><a href="#データの抽出">12. データの抽出</a></li>
            <li><a href="#時系列データts">13. 時系列データ(ts)</a></li>
            <li><a href="#ファイルからのデータ読み込み">14. ファイルからのデータ読み込み</a></li>
            <li><a href="#乱数の生成">15. 乱数の生成</a></li>
            <li><a href="#繰り返し構文とforループ">16. 繰り返し構文とforループ</a></li>
            <li><a href="#外部パッケージの活用">17. 外部パッケージの活用</a></li>
            </ul></li>
            <li><a href="#章-データの要約">2-2章: データの要約</a>
            <ul>
            <li><a href="#度数度数分布ヒストグラム">2. 度数・度数分布・ヒストグラム</a></li>
            <li><a href="#カーネル密度推定">3. カーネル密度推定</a></li>
            <li><a href="#算術平均">4. 算術平均</a></li>
            <li><a href="#中央値四分位点パーセント点">5. 中央値・四分位点・パーセント点</a></li>
            <li><a href="#共分散とピアソンの積率相関係数">6. 共分散とピアソンの積率相関係数</a></li>
            <li><a href="#自己共分散自己相関係数コレログラム">7. 自己共分散・自己相関係数・コレログラム</a></li>
            </ul></li>
            <li><a href="#章-ggplot2によるデータの可視化">2-3章 ggplot2によるデータの可視化</a>
            <ul>
            <li><a href="#ggplot2の基本">2. ggplot2の基本</a></li>
            <li><a href="#データの読み込み">3. データの読み込み</a></li>
            <li><a href="#ヒストグラムとカーネル密度推定">4. ヒストグラムとカーネル密度推定</a></li>
            <li><a href="#グラフの重ね合わせと一覧表示">5. グラフの重ね合わせと一覧表示</a></li>
            <li><a href="#箱ひげ図とバイオリンプロット">3.6 箱ひげ図とバイオリンプロット</a></li>
            <li><a href="#散布図">3.7 散布図</a></li>
            <li><a href="#折れ線グラフ">3.8 折れ線グラフ</a></li>
            </ul></li>
            <li><a href="#の補足ggplot2の考え方rグラフィックブック付録a">2-3の補足：ggplot2の考え方(Rグラフィックブック付録A)</a>
            <ul>
            <li><a href="#wideフォーマットとlongフォーマット">wideフォーマットとlongフォーマット</a></li>
            <li><a href="#ggplotの用語">ggplotの用語</a></li>
            <li><a href="#基本的な使い方">基本的な使い方</a></li>
            </ul></li>
            <li><a href="#章-stanの基本">2-4章 Stanの基本</a>
            <ul>
            <li><a href="#stanのインストール">2. Stanのインストール</a></li>
            <li><a href="#サンプルとmcmcサンプル">3. サンプルとMCMCサンプル</a></li>
            <li><a href="#ここで推定するモデルの構造">4. ここで推定するモデルの構造</a></li>
            <li><a href="#rとstan">5. RとStan</a></li>
            <li><a href="#stanファイルの書き方">6. Stanファイルの書き方</a></li>
            <li><a href="#stanファイルの実装例">7. Stanファイルの実装例</a></li>
            <li><a href="#rファイル実装の流れ">8. Rファイル実装の流れ</a></li>
            <li><a href="#分析の準備">9. 分析の準備</a></li>
            <li><a href="#データ読み込み">10. データ読み込み</a></li>
            <li><a href="#list形式でデータをまとめる">11. list形式でデータをまとめる</a></li>
            <li><a href="#stanと連携してmcmc実行">12. Stanと連携してMCMC実行</a></li>
            <li><a href="#結果の確認">13. 結果の確認</a></li>
            <li><a href="#収束の確認">14. 収束の確認</a></li>
            <li><a href="#ベクトル化">15. ベクトル化</a></li>
            <li><a href="#モデルの図式化">16. モデルの図式化</a></li>
            </ul></li>
            <li><a href="#stanコーディングの詳細">2-6. Stanコーディングの詳細</a>
            <ul>
            <li><a href="#stanファイルの構造">2. Stanファイルの構造</a></li>
            <li><a href="#変数の宣言">3. 変数の宣言</a></li>
            <li><a href="#代入">4. 代入</a></li>
            <li><a href="#サンプリング文">5. サンプリング文</a></li>
            <li><a href="#弱情報事前分布の設定">6. 弱情報事前分布の設定</a></li>
            <li><a href="#mcmcの実行">2. MCMCの実行</a></li>
            <li><a href="#mcmcサンプルの抽出">3. MCMCサンプルの抽出</a></li>
            <li><a href="#mcmcサンプルの代表値の計算">4. MCMCサンプルの代表値の計算</a></li>
            <li><a href="#トレースプロットの描画">5. トレースプロットの描画</a></li>
            <li><a href="#事後予測チェックの概要">10. 事後予測チェックの概要</a></li>
            <li><a href="#事後予測チェックの対象となるデータとモデル">11. 事後予測チェックの対象となるデータとモデル</a></li>
            </ul></li>
            <li><a href="#stanコーディングの詳細-1">2-6. Stanコーディングの詳細</a>
            <ul>
            <li><a href="#stanファイルの構造-1">2. Stanファイルの構造</a></li>
            <li><a href="#変数の宣言-1">3. 変数の宣言</a></li>
            <li><a href="#代入-1">4. 代入</a></li>
            <li><a href="#サンプリング文-1">5. サンプリング文</a></li>
            <li><a href="#弱情報事前分布の設定-1">6. 弱情報事前分布の設定</a></li>
            <li><a href="#対数密度加算文">7. 対数密度加算文</a></li>
            <li><a href="#平均値の差の評価とgenerated-quantitiesブロック">8. 平均値の差の評価とgenerated quantitiesブロック</a></li>
            <li><a href="#練習問題">練習問題</a></li>
            </ul></li>
            </ul>
          </div>
          <div data-position="sidebar:post-end" class="InjectedComponents"><div class="dark-theme-toggler"><div class="toggle "><div class="toggle-track"><div class="toggle-track-check"><img  src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16"></div> <div class="toggle-track-x"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KTMInWQAABwNJREFUWAmtV1tsFFUY/s6Z2d22zLYlZakUCRVaQcqlWIiCiS1gTEB9UAO+GR9En3iQGI0xJiSiRB98MjEq8cEQTSBeHhQM0V7whtEGDWC90BYitxahtNtu25058/v/ZzvLbilawJNM5+yZ89+//1LgJhYRNLW1uDfBAvpGiIk2O5auvfFxqIH3ZJ8/u06GN6Z9+wVl5SjcD1IbZa/UPkPyYl2uR4dreoD2bnbYxTlBBRytkHXtAREphP5KuH4lddx9h70yxX05t7yYXwGb6W8nx1jibpl2rFlGBxcG9M18okOrn7Bnk/BAO/4bI0UeEE1zjBp3UmvjOxJXJdaKN/ZiIu4tOZrAb4aTdZAZArKmWeiiJZ6jt5tiagdCS9+6cgO1Ne6Mvhe+ixTIfyDVhipnK9p+P0Edqx9RW/YZtQVGmOLChRxNNlyPsTEgPQKMB3dbEHa0h1awYmQ83enTd2vmUtvKd1Glv2RkzBb+kZGRrKtjzG60Wguhd/lJZBingbcfWWe72vjT75bJDrhYtvA0hrurETDr5HyF2Knb1MM4ab//xIoOqueA0edRnkkinTyJdYvqLFDZO4zUPFCvVoDjJq4T7TE61IWh4x5KqxX5KVKkX8WZ/t2ov2cb3MHt4dhIyOxIJxJOOF6xRx/99BksXLoecWcXytILMNBDqKpnGZWPquYfPxY8iXGR9fK+SgFrgcRPXPjVqhehL+3EmZ5RGJQi1QBU8TPThQnOQzm+5UXGIcetUeEAfP13VwzpI+w1jGJWdSliNfvVhiMPiOsllJag4M/UGHiqM6dlBb2OTLKHHV6KkvogrJ4XhBWniWK/Gp1MQyf93FOeUXKmKk/FzJxbQtKLjFXYT4USupy8fQVir2ynVEBiZMG0qtOHMS/AW4Gwrk7BG3C1F0B5nqNKE0CME4MfVRLPnXkBKe+ipvoFhNQywOhdghvLi0F8ReyVXV4BKTBRbbe5f64zR/DHsdZw1hJfeWlHl/GNRJzDxrd5m192z78TMaVnKELZoINZS4BzQ7vtnZljSnha/pPCbkuxzXcupYwI5tIeCpGc0Yp9tWHZQy/rmYhRfNgg4bHJBYLzGkxsRJF4XKlE2jBOHNSv3kY7Tj6vthzPFl61BrYwqFlmEQhtSVXmLiksxLmtRgYXI1ULU61JJ4eVKmG3/5sCVgpbMT6OMJ2E08/29Xf3w6v4FnHdCjfWgXu/O8Z5mLdCkeRs2khHe1DqOtQwbHWTAnM5S2HNmhALYo5KjkPFrMMKjZl6HxhWIAb0BqE+/73GrBRQUsKYiBu4JX8ycI6wtw+i5ef3NZpsrKVSHYCP37jwGDgeE1SA0S/xtl5SU2fs1ApEp0qTLVRjgyycDSsLHMSwmFltZMStR3uLLg6BdLhDa5dC6ryU2pHBe1BVO9tUcwfitJt2CLJZUHoG6T7Op75u0IyK31TCPcwFqgPk/KCaD3dFOuZBCO7xvCT/j048b3I3c7F2+WuOW7qdgkucFYlcQ4qop3yzTX7WaKfOCccye3Ts1Etq0+a/BHCF1yPgF3tAUkR6OrtGmo6gl94qqcXKh3rDyrOkPa58URoWcov2Mo6M+0QjrqKB+b7++oMa9Sz+ZkM0mie6aAtnGUvhmxaI+TogPOSQedgWioGSHFLn3v4kLh4HRspNmOGv41k+55siLFp2z6xYeJjhljFcbmxJlr4ga06TbevSByz/glQq4BJx46/c+237PbBqEYKxX3HpmKZEnQnr65X20hqJYaNcLoFOLiJk2LuBbyg7Q0OEn+hm0P3honxFD6rdxYorKpeIoi4YSSvyQHQIbM5t4+YNxLj/OxhVOOE4585qGpjnq+wSx6Q9CtNxTjd5klB+g6Mv36r0+b9cZFi44WYkHdG2ZWb3TtOUOXyVAlKlpGvJIAJ3eBMyfYS5C0qRZGtC85j+4sOasDe9xznPYezhhO/2Q6eP2fSOvYHOjtuQ1a9Q1VKynVDaMc8E0tptdxUsTFpFIYjcZKcbnoaQTNdiqCwNlL4G7oziSqGnT1ALf34vhk4R5zU3qYV9ONp9K88RtouShE68JwaU8dFw5W617shWa9ykeaBIn2hcsvPgL00k45QdTCZuSVcTRNs+8fnyLvooQfR5iujAnR9bxfY2xOVOxFS8SK3Le0l48VyYu1M8HRe5JD8wKPTjYnifaK3Wfn/GChYQ8ZAi6WRzWgqLV5YrsVLnZaVSoXU1g9gOIDwFySiGi+Zdrnzr7J3r+SMuszlcQCRn8lNGcTuSy2jOI7o9mxjZo+vR3ej3tN+ifRSOyUTS0+VMOid93cCubeiy/6TImS0QxRSCq2vxKr45zV+FQnjWH6D2xg+E9EatLcLAdHTgtGGD80D6jM0+aOl4wJgO/f96R2aJKCQ3yvgftRhdFMOpd6oAAAAASUVORK5CYII=" role="presentation" style="pointer-events: none;" width="16" height="16"></div></div> <div class="toggle-thumb"></div></div> <input type="checkbox" aria-label="Switch between Dark and Default theme" class="toggler-screen-reader-only"></div></div>
        </div>
        <div class="Main">
          <div class="Content" id="content"> 
   
   
      
      <div class="navbar navbar-default  navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">my public memo</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li>
        <a href="index.html">Home</a>
      </li>
      <li>
        <a href="baba1.html">馬場本1章</a>
      </li>
      <li>
        <a href="baba2.html">馬場本2章</a>
      </li>
      <li>
        <a href="baba3.html">馬場本3章</a>
      </li>
      <li>
        <a href="psytech.html">技術部</a>
      </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              
            </ul>
          </div><!--/.nav-collapse -->
        </div><!--/.container -->
      </div><!--/.navbar -->
        
      <h1 class="title">馬場本</h1>
      
      <p class="authors">
           <span class="glyphicon glyphicon-user"></span> Toshihide Imaruoka
      </p>
              

   
      
   
<!-- Don't indent these lines or it will mess pre blocks indentation --> 
<div class="page-content has-page-title">
<div id="章" class="section level1">
<h1>2章</h1>
</div>
<div id="章rの基本" class="section level1">
<h1>2-1章：Rの基本</h1>
<div id="目的と概要" class="section level2">
<h2>1. 目的と概要</h2>
<ul>
<li>Rインストール</li>
<li>基本事項</li>
<li>応用</li>
</ul>
</div>
<div id="rのインストール" class="section level2">
<h2>2. Rのインストール</h2>
</div>
<div id="rstudioのインストール" class="section level2">
<h2>3. RStudioのインストール</h2>
</div>
<div id="rstudioの使い方" class="section level2">
<h2>4. RStudioの使い方</h2>
<ul>
<li>プロジェクトの作成</li>
<li>スクリプトの作成</li>
</ul>
</div>
<div id="変数" class="section level2">
<h2>5. 変数</h2>
<ul>
<li>’&lt;-’による代入</li>
<li>print()や変数名で表示</li>
<li>因子型:</li>
</ul>
</div>
<div id="関数" class="section level2">
<h2>6. 関数</h2>
<ul>
<li>引数</li>
</ul>
</div>
<div id="ベクトル" class="section level2">
<h2>7. ベクトル</h2>
<ul>
<li>vector &lt;- c(1,2,3,4,5)</li>
<li>1:10 等差数列</li>
</ul>
</div>
<div id="行列" class="section level2">
<h2>8. 行列</h2>
<pre class="r"><code>mtrx&lt;-matrix(
  data=1:10,
  nrow=2,
  byrow=F
)
rownames(mtrx)&lt;-c(&#39;row1&#39;,&#39;row2&#39;)
colnames(mtrx)&lt;-c(&#39;c1&#39;,&#39;c2&#39;,&#39;c3&#39;,&#39;c4&#39;,&#39;c5&#39;)
print(mtrx)</code></pre>
<pre><code>##      c1 c2 c3 c4 c5
## row1  1  3  5  7  9
## row2  2  4  6  8 10</code></pre>
</div>
<div id="配列" class="section level2">
<h2>9. 配列</h2>
<ul>
<li>arry&lt;-array(data=1:30, dim=c(3,5,2))</li>
</ul>
</div>
<div id="データフレーム" class="section level2">
<h2>10. データフレーム</h2>
<ul>
<li>列ごとにっデータの種類を変えられる</li>
<li>df &lt;-data.frame()</li>
<li>nrow(df)</li>
</ul>
</div>
<div id="リスト" class="section level2">
<h2>11. リスト</h2>
<ul>
<li>さらに上位構造としてのリスト</li>
<li>lst &lt;- list( a=c(1,2,3), b=mtrx, c=df )</li>
</ul>
</div>
<div id="データの抽出" class="section level2">
<h2>12. データの抽出</h2>
<ul>
<li>[]での抽出</li>
<li>a&lt;-matrix(data=1:10,nrow=2) でa[,1]のようにすれば特定列のみ、特定行のみ抽出</li>
<li>a[1, 2:3]のようなことも可能</li>
<li>dim()で要素数、dimnamesで要素名を調べる</li>
<li>行名や列名でも指定可能</li>
<li>データフレームの場合、$で列名を指定可能</li>
<li>head(df,n)、データフレームdfの先頭n行を表示</li>
<li>listでも$を使える</li>
</ul>
</div>
<div id="時系列データts" class="section level2">
<h2>13. 時系列データ(ts)</h2>
<ul>
<li>ts()</li>
</ul>
<pre class="r"><code>df2 &lt;- data.frame(
  data=1:24
)
ts2&lt;-ts(
  df2, # 対象データ
  start = c(2010,1), #開始年月
  frequency=12 #頻度
)
print(ts2)</code></pre>
<pre><code>##      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
## 2010   1   2   3   4   5   6   7   8   9  10  11  12
## 2011  13  14  15  16  17  18  19  20  21  22  23  24</code></pre>
</div>
<div id="ファイルからのデータ読み込み" class="section level2">
<h2>14. ファイルからのデータ読み込み</h2>
<ul>
<li>read.csv()</li>
</ul>
</div>
<div id="乱数の生成" class="section level2">
<h2>15. 乱数の生成</h2>
<ul>
<li>rnorm(n=, mean=, sd=): 正規分布に従う乱数</li>
<li>set.seed(): seedを設定すれば同じ乱数を生成できる</li>
</ul>
</div>
<div id="繰り返し構文とforループ" class="section level2">
<h2>16. 繰り返し構文とforループ</h2>
<ul>
<li>for (i in 1:3){}のような形</li>
</ul>
</div>
<div id="外部パッケージの活用" class="section level2">
<h2>17. 外部パッケージの活用</h2>
<ul>
<li>install.packages()</li>
</ul>
</div>
</div>
<div id="章-データの要約" class="section level1">
<h1>2-2章: データの要約</h1>
<div id="度数度数分布ヒストグラム" class="section level2">
<h2>2. 度数・度数分布・ヒストグラム</h2>
<ul>
<li>hist()</li>
</ul>
<pre class="r"><code>fish&lt;-read.csv(&#39;2-2-1-fish.csv&#39;)
hist(fish$length)</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-3-1.png" width="768" /></p>
</div>
<div id="カーネル密度推定" class="section level2">
<h2>3. カーネル密度推定</h2>
<ul>
<li>ヒストグラムを滑らかに</li>
<li>density()</li>
</ul>
<pre class="r"><code>fish&lt;-read.csv(&#39;2-2-1-fish.csv&#39;)
plot(density(fish$length, adjust=1))</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-4-1.png" width="768" /></p>
</div>
<div id="算術平均" class="section level2">
<h2>4. 算術平均</h2>
<ul>
<li>mean()</li>
</ul>
</div>
<div id="中央値四分位点パーセント点" class="section level2">
<h2>5. 中央値・四分位点・パーセント点</h2>
<ul>
<li>median()</li>
<li>quautile(data, c(v1, v2))</li>
</ul>
</div>
<div id="共分散とピアソンの積率相関係数" class="section level2">
<h2>6. 共分散とピアソンの積率相関係数</h2>
<ul>
<li>共分散: <span class="math inline">\(\frac{1}{N} \Sigma^N_{i=1} (x_i-\bar{x})(y_i-\bar{y}))\)</span></li>
<li>ピアソンの積率相関係数: <span class="math inline">\(\rho_{xy}=\frac{\Sigma^N_{i=1}(x_i-\bar{x})(y_i-\bar{y})}{\sqrt{\{\Sigma^N_{i=1}(x_i-\bar{x})^2\}\{\Sigma^N_{i=1}(y_i-\bar{y})^2\}}}\)</span></li>
<li>cor(varx, vary)</li>
</ul>
</div>
<div id="自己共分散自己相関係数コレログラム" class="section level2">
<h2>7. 自己共分散・自己相関係数・コレログラム</h2>
<ul>
<li>jikosoukannkeisuu: 時系列データにおける過去のデータとの相関
<ul>
<li>1次：1時点前との相関</li>
<li>2次：2時点前との相関</li>
<li><span class="math inline">\(\frac{1}{N}\Sigma^N_{i=1}(y_t-\bar{y})(y_{t-1}-\bar{y})\)</span></li>
<li>acf()</li>
</ul></li>
</ul>
<pre class="r"><code>acf(Nile)</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-5-1.png" width="768" /></p>
</div>
</div>
<div id="章-ggplot2によるデータの可視化" class="section level1">
<h1>2-3章 ggplot2によるデータの可視化</h1>
<div id="ggplot2の基本" class="section level2">
<h2>2. ggplot2の基本</h2>
<ol style="list-style-type: decimal">
<li>データフレームにする</li>
<li>ggolot関数でグラフのベースを作る</li>
<li>ベースにグラフを追加していく</li>
<li>グラフタイトルなどを追加していく</li>
</ol>
</div>
<div id="データの読み込み" class="section level2">
<h2>3. データの読み込み</h2>
</div>
<div id="ヒストグラムとカーネル密度推定" class="section level2">
<h2>4. ヒストグラムとカーネル密度推定</h2>
</div>
<div id="グラフの重ね合わせと一覧表示" class="section level2">
<h2>5. グラフの重ね合わせと一覧表示</h2>
<pre class="r"><code>library(&#39;ggplot2&#39;)</code></pre>
<pre><code>## Warning in register(): Can&#39;t find generic `scale_type` in package ggplot2 to
## register S3 method.</code></pre>
<pre class="r"><code>fish &lt;- read.csv(&#39;2-2-1-fish.csv&#39;)
head(fish, n=3)</code></pre>
<pre><code>##      length
## 1  8.747092
## 2 10.367287
## 3  8.328743</code></pre>
<pre class="r"><code>ggplot(data=fish, mapping=aes(x=length))+geom_histogram(alpha=0.5, bins=20)+labs(title=&#39;ヒストグラム&#39;)</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-6-1.png" width="768" /></p>
<pre class="r"><code>fish &lt;- read.csv(&#39;2-2-1-fish.csv&#39;)
head(fish, n=3)</code></pre>
<pre><code>##      length
## 1  8.747092
## 2 10.367287
## 3  8.328743</code></pre>
<pre class="r"><code>ggplot(data=fish, mapping=aes(x=length, y=..density..))+geom_histogram(alpha=0.5, bins=20)+geom_density(size=1.5)+labs(title=&#39;ヒストグラム&#39;)</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-7-1.png" width="768" /></p>
<pre class="r"><code>library(gcookbook)
library(gridExtra)
p_hist&lt;-ggplot(data=fish, mapping=aes(x=length))+geom_histogram(alpha=0.5, bins=20)+labs(title=&quot;ヒストグラム&quot;)
p_density&lt;-ggplot(data=fish, mappin=aes(x=length))+geom_density(size=1.5)+labs(title=&quot;カーネル密度推定&quot;)
grid.arrange(p_hist, p_density, nrow=2)+theme(plot.title=element_text(family=&quot;Hirakaku&quot;))</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-8-1.png" width="768" /></p>
<pre><code>## NULL</code></pre>
</div>
<div id="箱ひげ図とバイオリンプロット" class="section level2">
<h2>3.6 箱ひげ図とバイオリンプロット</h2>
<ul>
<li>箱ひげ図：四分位点、中央値　geom_boxplot</li>
<li>バイオリンプロット geom_violin</li>
</ul>
</div>
<div id="散布図" class="section level2">
<h2>3.7 散布図</h2>
<ul>
<li>2変数間の関係 geom_point</li>
</ul>
</div>
<div id="折れ線グラフ" class="section level2">
<h2>3.8 折れ線グラフ</h2>
<ul>
<li>時系列データ geom_line</li>
</ul>
</div>
</div>
<div id="の補足ggplot2の考え方rグラフィックブック付録a" class="section level1">
<h1>2-3の補足：ggplot2の考え方(Rグラフィックブック付録A)</h1>
<div id="wideフォーマットとlongフォーマット" class="section level2">
<h2>wideフォーマットとlongフォーマット</h2>
<ul>
<li>属性を縦と横に配置した表: wideフォーマット</li>
</ul>
<pre class="r"><code>library(gcookbook)
simpledat</code></pre>
<pre><code>##    A1 A2 A3
## B1 10  7 12
## B2  9 11  6</code></pre>
<pre><code>* データが複数の列に入る</code></pre>
<ul>
<li>1種類のデータは1列にまとまるべき
<ul>
<li>reshapeパッケージ、melt()</li>
</ul></li>
</ul>
<pre class="r"><code>library(reshape2)
longdat&lt;-melt(simpledat)
longdat</code></pre>
<pre><code>##   Var1 Var2 value
## 1   B1   A1    10
## 2   B2   A1     9
## 3   B1   A2     7
## 4   B2   A2    11
## 5   B1   A3    12
## 6   B2   A3     6</code></pre>
</div>
<div id="ggplotの用語" class="section level2">
<h2>ggplotの用語</h2>
<ul>
<li>データ：視覚化の対象、変数で構成される</li>
<li>幾何オブジェクト：描画されるもの。データを表現したもの。</li>
<li>エステティック属性：幾何オブジェクトの視覚的プロパティ（x, yの位置、線の色など）</li>
<li>マッピング：「データの値をエステティック属性にマッピングする」</li>
<li>スケール：データ空間の値とエステティック空間の値との関係。</li>
<li>ガイド：目盛りやラベル</li>
</ul>
</div>
<div id="基本的な使い方" class="section level2">
<h2>基本的な使い方</h2>
<ul>
<li>ggplot(データ, エステティック属性)+描画オブジェクト
<ul>
<li>ggplot(longdat, aes(x=xval, y=yval))
<ul>
<li>xvalがx軸に、yvalがy軸にマッピングされる</li>
</ul></li>
<li><ul>
<li>geom_point()</li>
<li>上のものに幾何オブジェクトを足すと描画できる。この例では散布図。</li>
</ul></li>
<li><ul>
<li>geom_point(aes(colour=group))</li>
<li>このようにエステティック属性としてcolourを指定すると指定した属性を色にマッピングできる。</li>
</ul></li>
<li>+scale_x_continuous(limits=c(0,8))
<ul>
<li>xの範囲を広げる</li>
</ul></li>
<li>print(オブジェクト）
<ul>
<li>オブジェクトを明示的に表示</li>
</ul></li>
<li>ここまでの例。</li>
</ul></li>
</ul>
<pre class="r"><code>library(ggplot2)
dat &lt;- data.frame(xval=1:4,yval=c(3,5,6,9), group=c(&quot;A&quot;, &quot;B&quot;, &quot;A&quot;, &quot;B&quot;))
p&lt;-ggplot(dat,aes(x=xval,y=yval))
p2&lt;-p+geom_point(aes(colour=group))
p2+scale_x_continuous(limits=c(0,8))</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-11-1.png" width="768" /></p>
<pre class="r"><code>print(p2)</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-11-2.png" width="768" /></p>
</div>
</div>
<div id="章-stanの基本" class="section level1">
<h1>2-4章 Stanの基本</h1>
<div id="stanのインストール" class="section level2">
<h2>2. Stanのインストール</h2>
<ul>
<li>done</li>
</ul>
</div>
<div id="サンプルとmcmcサンプル" class="section level2">
<h2>3. サンプルとMCMCサンプル</h2>
<ul>
<li>サンプル：抽出した標本</li>
<li>MCMCサンプル：MCMCから得た乱数</li>
</ul>
</div>
<div id="ここで推定するモデルの構造" class="section level2">
<h2>4. ここで推定するモデルの構造</h2>
<ul>
<li>ビールの売り上げ（1部5章5.5節）
<ul>
<li>売り上げ（単位：万円）を記録したデータ100個</li>
<li>売り上げデータは正規分布に従う</li>
<li>売り上げ平均<span class="math inline">\(\mu\)</span>, ばらつき<span class="math inline">\(\sigma\)</span></li>
<li><span class="math inline">\(sales \sim Normal(\mu, \sigma^2)\)</span></li>
</ul></li>
</ul>
</div>
<div id="rとstan" class="section level2">
<h2>5. RとStan</h2>
<ul>
<li>この本では
<ul>
<li>R: 基本的なデータ処理</li>
<li>Stan: MCMC</li>
</ul></li>
<li>Stanコード
<ul>
<li>拡張子stan</li>
<li>textファイルを拡張子stanで保存
<ul>
<li>RStudioでstanファイルを作成してもOK.構造が予め用意されている。</li>
</ul></li>
</ul></li>
<li>この本でのベイズ統計モデリングデータ分析
<ol style="list-style-type: decimal">
<li>Rファイル</li>
<li>Stanファイル（MCMC用）資料ではオレンジ色枠</li>
<li>標本が格納されたcsvファイル</li>
</ol></li>
</ul>
</div>
<div id="stanファイルの書き方" class="section level2">
<h2>6. Stanファイルの書き方</h2>
<ul>
<li>基本的な構造
<ul>
<li>dataブロック: データ、サンプルサイズ</li>
<li>parameterブロック：事後分布を得るパラメータ一覧</li>
<li>modelブロック：事前分布、尤度
<ul>
<li>事前分布を指定しないと<span class="math inline">\((-\infty, \infty)\)</span>の一様分布</li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="stanファイルの実装例" class="section level2">
<h2>7. Stanファイルの実装例</h2>
<ul>
<li>2-4-1-calc-mean-variance.stanというファイル名で作成</li>
</ul>
</div>
<div id="rファイル実装の流れ" class="section level2">
<h2>8. Rファイル実装の流れ</h2>
<ul>
<li>2-4-Stnの基本.Rを作成
<ol style="list-style-type: decimal">
<li>パッケージ読み込みなどの準備</li>
<li>データ読み込みと確認</li>
<li>list形式でデータをまとめる</li>
<li>Stant連携、MCMC実行</li>
<li>結果確認</li>
</ol>
<ul>
<li>収束も確認</li>
</ul></li>
</ul>
</div>
<div id="分析の準備" class="section level2">
<h2>9. 分析の準備</h2>
<ul>
<li>rstan_options(auto_write=TRUE)
<ul>
<li>.rdsファイル生成</li>
<li>再度のコンパイルを不要にする</li>
</ul></li>
<li>options(mc.cores=)
<ul>
<li>計算の並列化。コンピュータのコア数に応じて指定してくれる。</li>
</ul></li>
<li>基本的にどちらもいつも指定する</li>
</ul>
</div>
<div id="データ読み込み" class="section level2">
<h2>10. データ読み込み</h2>
<ul>
<li>read.csv</li>
<li>この例では確認は省略</li>
</ul>
</div>
<div id="list形式でデータをまとめる" class="section level2">
<h2>11. list形式でデータをまとめる</h2>
<ul>
<li>Stanファイルのデータブロックに必要なデータ数Nとデータsalesをlistにしておく</li>
</ul>
</div>
<div id="stanと連携してmcmc実行" class="section level2">
<h2>12. Stanと連携してMCMC実行</h2>
<ul>
<li>stan関数
<ul>
<li>引数はP118の通り</li>
<li>実際にはMCMCサンプルは毎回異なるが、seed=1を指定することで固定。</li>
</ul></li>
</ul>
<pre class="r"><code>library(rstan)</code></pre>
<pre><code>##  要求されたパッケージ StanHeaders をロード中です</code></pre>
<pre><code>## rstan (Version 2.21.3, GitRev: 2e1f913d3ca3)</code></pre>
<pre><code>## For execution on a local, multicore CPU with excess RAM we recommend calling
## options(mc.cores = parallel::detectCores()).
## To avoid recompilation of unchanged Stan programs, we recommend calling
## rstan_options(auto_write = TRUE)</code></pre>
<pre class="r"><code>rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())

file_beer_sales_1 &lt;- read.csv(&quot;2-4-1-beer-sales-1.csv&quot;)

sample_size&lt;-nrow(file_beer_sales_1)
data_list&lt;-list(sales=file_beer_sales_1$sales, N=sample_size)

mcmc_result&lt;-stan(
  file=&quot;2-4-1-calc.mean-variance.stan&quot;,
  data=data_list,
  seed=1,
  chains=4,
  iter=2000,
  warmup=1000,
  thin=1
)</code></pre>
</div>
<div id="結果の確認" class="section level2">
<h2>13. 結果の確認</h2>
<ul>
<li>print()でmcmcの戻り値を表示
<ul>
<li>求めるパラメータ, mu, sigma, lp__:対数事後確率</li>
</ul></li>
</ul>
<pre class="r"><code>print(mcmc_result, probs=c(0.025,0.5,0.975))</code></pre>
<pre><code>## Inference for Stan model: 2-4-1-calc.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##          mean se_mean   sd    2.5%     50%   97.5% n_eff Rhat
## mu     102.22    0.03 1.83   98.61  102.23  105.79  3283    1
## sigma   18.19    0.02 1.27   15.93   18.12   20.98  2758    1
## lp__  -336.43    0.02 0.96 -338.94 -336.13 -335.48  1905    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Jan 27 11:16:21 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
<div id="収束の確認" class="section level2">
<h2>14. 収束の確認</h2>
<ul>
<li>traceplot関数でstan関数の戻り値を処理</li>
<li>4回の結果（4つのチェーン）が重なっていればOK</li>
<li>traceplot(mcmc_result, inc_warmup=T)
<ul>
<li>バーンイン期間も表示</li>
</ul></li>
</ul>
<pre class="r"><code>traceplot(mcmc_result)</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-14-1.png" width="768" /></p>
</div>
<div id="ベクトル化" class="section level2">
<h2>15. ベクトル化</h2>
<ul>
<li><span class="math inline">\(sales[N] \sim normal(mu, sigma)\)</span> をベクトルにする</li>
<li><span class="math inline">\(sales \sim normal(mu, sigma)\)</span>
<ul>
<li>わずかに結果が変わる</li>
</ul></li>
</ul>
</div>
<div id="モデルの図式化" class="section level2">
<h2>16. モデルの図式化</h2>
<ul>
<li>モデルの構造を図式化</li>
<li>グラフィカルモデル
<ul>
<li>実際のデータ：四角形</li>
<li>確率分布：円</li>
<li>確率的な関係：波線</li>
<li>確定的関係：実線</li>
</ul></li>
</ul>
</div>
</div>
<div id="stanコーディングの詳細" class="section level1">
<h1>2-6. Stanコーディングの詳細</h1>
<div id="stanファイルの構造" class="section level2">
<h2>2. Stanファイルの構造</h2>
<ul>
<li>Stanファイルの構成
<ul>
<li>function</li>
<li>data</li>
<li>transformed data</li>
<li>parameters</li>
<li>transformed parameters</li>
<li>model</li>
<li>generated quntities</li>
</ul></li>
</ul>
</div>
<div id="変数の宣言" class="section level2">
<h2>3. 変数の宣言</h2>
<ul>
<li>型と範囲
<ul>
<li>int N</li>
<li>real beta;</li>
<li>real&lt;lower=0&gt; beta;</li>
<li>int&lt;lower=0, upper=1&gt; range;</li>
</ul></li>
<li>ベクトル、配列の宣言
<ul>
<li>ベクトル、行列
<ul>
<li>実数値型</li>
<li>vector[3] retu;</li>
<li>row_vector[10] gyou;</li>
<li>matrix[3,2] mat;</li>
</ul></li>
<li>配列
<ul>
<li>ベクトルより柔軟、データ型を複数持てる</li>
<li>int w[10];</li>
<li>real x[3,4];</li>
<li>vector[4] Y[2]; //4要素のベクトルを2つ持つ配列Y</li>
<li>matrix[3,4] Z[5,6]; //3x4の行列を要素に持つ5x6の配列Z</li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="代入" class="section level2">
<h2>4. 代入</h2>
<ul>
<li>transformed dataブロックやtransformed parametersブロック</li>
<li>= 代入演算子</li>
</ul>
</div>
<div id="サンプリング文" class="section level2">
<h2>5. サンプリング文</h2>
<ul>
<li>modelブロック</li>
<li>ビール売上の例
<ul>
<li>売上平均値のパラメータ<span class="math inline">\(\mu\)</span>, ばらつき<span class="math inline">\(\sigma^2\)</span></li>
<li>売上salesは平均<span class="math inline">\(\mu\)</span>, ばらつき<span class="math inline">\(\sigma^2\)</span>の正規分布からサンプリングされたと想定</li>
<li><span class="math inline">\(sales \sim Normal(\mu, \sigma^2)\)</span></li>
<li>N: サンプルサイズとして
<ul>
<li>model{ for (i in 1:N){ sales[i] ~ normal(mu, sigma) } }</li>
</ul></li>
<li>左辺ではデータでも、未知のパラメータでもOK</li>
<li>muとsigmaの事前分布は指定できる</li>
<li>model{ mu ~ normal(0, 1000000); sigma ~ normal(0, 1000000); for (i in 1:N){ sales[i] ~ normal(mu, sigma); } }</li>
<li>事前分布を変えたときに結果（＝事後分布）がどう変わってくるかの確認作業：感度分析</li>
</ul></li>
</ul>
</div>
<div id="弱情報事前分布の設定" class="section level2">
<h2>6. 弱情報事前分布の設定</h2>
<ul>
<li>パラメータの範囲が”ある程度”分かっているとき</li>
<li>“やや狭い”事前分布
<ul>
<li>例えば-5から5が想定されるとして、
<ul>
<li>uniform(-5, 5)のように範囲が厳格に決まった一様分布よりも</li>
<li>normal(0, 5)のような緩やかに範囲が決められる決め方が良い
<ul>
<li>t分布が使われたりもする</li>
<li>Prior Choice Recommendations参照</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p>======= # 2-5章 MCMCの結果の評価</p>
</div>
<div id="mcmcの実行" class="section level2">
<h2>2. MCMCの実行</h2>
<ul>
<li>4章と同じ解析を実行</li>
</ul>
<pre class="r"><code>mcmc_result&lt;-stan(
  file=&quot;2-4-1-calc.mean-variance3.stan&quot;,
  data=data_list,
  seed=1,
  chains=4,
  iter=2000,
  warmup=1000,
  thin=1
)</code></pre>
</div>
<div id="mcmcサンプルの抽出" class="section level2">
<h2>3. MCMCサンプルの抽出</h2>
<ul>
<li>rstan::extract(): stanfitクラスからmcmcサンプルを抽出する</li>
<li>mcmc_sample &lt;- rstan::extract(mcmc_result, permuted=FALSE)</li>
<li>抜き出されたmcmc_sampleオブジェクトはarrayクラス、dimsは1000（iter数-wamup数), 4(chans数), 3(mu, sigma, lp__)となる。
<ul>
<li>dim_names(mcmc_samples)で確認できる</li>
</ul></li>
<li>mcmc_sample[]で要素を見ることができる</li>
<li>mcmc_sample[,,mu]だと<span class="math inline">\(\mu\)</span>のMCMCサンプル全てを取り出せる</li>
</ul>
<pre class="r"><code>mcmc_sample&lt;-rstan::extract(mcmc_result, permuted=FALSE)
class(mcmc_sample)</code></pre>
<pre><code>## [1] &quot;array&quot;</code></pre>
<pre class="r"><code>dim(mcmc_sample)</code></pre>
<pre><code>## [1] 1000    4    3</code></pre>
<pre class="r"><code>dimnames(mcmc_sample)</code></pre>
<pre><code>## $iterations
## NULL
## 
## $chains
## [1] &quot;chain:1&quot; &quot;chain:2&quot; &quot;chain:3&quot; &quot;chain:4&quot;
## 
## $parameters
## [1] &quot;mu&quot;    &quot;sigma&quot; &quot;lp__&quot;</code></pre>
<pre class="r"><code>mcmc_sample[c(1:8),&quot;chain:1&quot;,&quot;mu&quot;]</code></pre>
<pre><code>## [1] 104.0878 104.4901 102.4625 101.3802 102.5435 104.7143 100.2602 104.0725</code></pre>
<pre class="r"><code>dim(mcmc_sample[,,&quot;mu&quot;])</code></pre>
<pre><code>## [1] 1000    4</code></pre>
<pre class="r"><code>class(mcmc_sample[,,&quot;mu&quot;])</code></pre>
<pre><code>## [1] &quot;matrix&quot; &quot;array&quot;</code></pre>
</div>
<div id="mcmcサンプルの代表値の計算" class="section level2">
<h2>4. MCMCサンプルの代表値の計算</h2>
<ul>
<li>事後分布の代表値の計算</li>
</ul>
<pre class="r"><code>mu_mcmc_vec &lt;- as.vector(mcmc_sample[,,&quot;mu&quot;])
median(mu_mcmc_vec)</code></pre>
<pre><code>## [1] 102.2262</code></pre>
<pre class="r"><code>mean(mu_mcmc_vec)</code></pre>
<pre><code>## [1] 102.2221</code></pre>
<pre class="r"><code>quantile(mu_mcmc_vec, probs=c(0.025, 0.975))</code></pre>
<pre><code>##     2.5%    97.5% 
##  98.6053 105.7918</code></pre>
</div>
<div id="トレースプロットの描画" class="section level2">
<h2>5. トレースプロットの描画</h2>
<ul>
<li>MCMCサンプルをもとにトレースプロットの描画</li>
</ul>
<pre class="r"><code>library(ggfortify)
autoplot(ts(mcmc_sample[,,&quot;mu&quot;]),
  facets = F,
  ylab = &quot;mu&quot;,
  main= &quot;トレースプロット&quot;)</code></pre>
<p><img src="baba2_files/figure-html/unnamed-chunk-18-1.png" width="768" /> 6. ggplot2による事後分布の可視化 * MCMCサンプルをまとめる＝パラメータの事後分布</p>
<pre class="r"><code>mu_df &lt;- data.frame(mu_mcmc_sample &lt;- mu_mcmc_vec)
ggplot(data=mu_df, mapping=aes(x=mu_mcmc_sample))+geom_density(size=1.5)</code></pre>
<p><img src="baba2_files/figure-html/ggplot2-1.png" width="768" /> ## 7. bayesplotによる事後分布の可視化 * bayesplot便利</p>
<pre class="r"><code>library(rstan)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())
library(bayesplot)</code></pre>
<pre><code>## This is bayesplot version 1.8.1</code></pre>
<pre><code>## - Online documentation and vignettes at mc-stan.org/bayesplot</code></pre>
<pre><code>## - bayesplot theme set to bayesplot::theme_default()</code></pre>
<pre><code>##    * Does _not_ affect other ggplot2 plots</code></pre>
<pre><code>##    * See ?bayesplot_theme_set for details on theme setting</code></pre>
<pre class="r"><code>mcmc_hist(mcmc_sample, parc=c(&quot;mu&quot;, &quot;sigma&quot;))</code></pre>
<pre><code>## Warning: The following arguments were unrecognized and ignored: parc</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="baba2_files/figure-html/bayesplot%20combo-1.png" width="768" /></p>
<pre class="r"><code>mcmc_combo(mcmc_sample, parc=c(&quot;mu&quot;,&quot;sigma&quot;))</code></pre>
<p><img src="baba2_files/figure-html/bayesplot%20combo-2.png" width="768" /> ## 8. bayesplotによる事後分布の範囲の比較 ## 9. bayesplotによるMCMCサンプルの自己相関の評価 * コレログラムも描ける</p>
</div>
<div id="事後予測チェックの概要" class="section level2">
<h2>10. 事後予測チェックの概要</h2>
<ul>
<li>推定されたモデルの総合的評価方法
<ul>
<li>例えば、仮定した事柄が現実的だったかどうか</li>
</ul></li>
<li>事後予測チェックとは？
<ul>
<li>統計モデル：観測したデータを生み出す確率的な過程を簡潔に記述したもの
<ul>
<li>ってことは、統計モデルをうまく推定できているなら、データとよく似たデータを生成できるはず</li>
<li>モデルにしたがって観測データを擬似的に生成=事後予測分布/事後分布</li>
<li>データと事後予測分布を比べる</li>
<li>その方法の一つとしての「図示」</li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="事後予測チェックの対象となるデータとモデル" class="section level2">
<h2>11. 事後予測チェックの対象となるデータとモデル</h2>
<ul>
<li>小動物の発見個体数
<ul>
<li>草原の中にランダムに個体が分布</li>
<li>試行回数が大きく、発生確率が小さい二項分布＝ポアソン分布</li>
<li>間違った分布として正規分布も考えてみる</li>
</ul></li>
</ul>
<pre class="r"><code>animal_num&lt;-read.csv(&quot;2-5-1-animal-num.csv&quot;)</code></pre>
</div>
</div>
<div id="stanコーディングの詳細-1" class="section level1">
<h1>2-6. Stanコーディングの詳細</h1>
<div id="stanファイルの構造-1" class="section level2">
<h2>2. Stanファイルの構造</h2>
<ul>
<li>Stanファイルの構成
<ul>
<li>function</li>
<li>data</li>
<li>transformed data</li>
<li>parameters</li>
<li>transformed parameters</li>
<li>model</li>
<li>generated quntities</li>
</ul></li>
</ul>
</div>
<div id="変数の宣言-1" class="section level2">
<h2>3. 変数の宣言</h2>
<ul>
<li>型と範囲
<ul>
<li>int N</li>
<li>real beta;</li>
<li>real&lt;lower=0&gt; beta;</li>
<li>int&lt;lower=0, upper=1&gt; range;</li>
</ul></li>
<li>ベクトル、配列の宣言
<ul>
<li>ベクトル、行列
<ul>
<li>実数値型</li>
<li>vector[3] retu;</li>
<li>row_vector[10] gyou;</li>
<li>matrix[3,2] mat;</li>
</ul></li>
<li>配列
<ul>
<li>ベクトルより柔軟、データ型を複数持てる</li>
<li>int w[10];</li>
<li>real x[3,4];</li>
<li>vector[4] Y[2]; //4要素のベクトルを2つ持つ配列Y</li>
<li>matrix[3,4] Z[5,6]; //3x4の行列を要素に持つ5x6の配列Z</li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="代入-1" class="section level2">
<h2>4. 代入</h2>
<ul>
<li>transformed dataブロックやtransformed parametersブロック</li>
<li>= 代入演算子</li>
</ul>
</div>
<div id="サンプリング文-1" class="section level2">
<h2>5. サンプリング文</h2>
<ul>
<li>modelブロック</li>
<li>ビール売上の例
<ul>
<li>売上平均値のパラメータ<span class="math inline">\(\mu\)</span>, ばらつき<span class="math inline">\(\sigma^2\)</span></li>
<li>売上salesは平均<span class="math inline">\(\mu\)</span>, ばらつき<span class="math inline">\(\sigma^2\)</span>の正規分布からサンプリングされたと想定</li>
<li><span class="math inline">\(sales \sim Normal(\mu, \sigma^2)\)</span></li>
<li>N: サンプルサイズとして
<ul>
<li>model{ for (i in 1:N){ sales[i] ~ normal(mu, sigma) } }</li>
</ul></li>
<li>左辺ではデータでも、未知のパラメータでもOK</li>
<li>muとsigmaの事前分布は指定できる</li>
<li>model{ mu ~ normal(0, 1000000); sigma ~ normal(0, 1000000); for (i in 1:N){ sales[i] ~ normal(mu, sigma); } }</li>
<li>事前分布を変えたときに結果（＝事後分布）がどう変わってくるかの確認作業：感度分析</li>
</ul></li>
</ul>
</div>
<div id="弱情報事前分布の設定-1" class="section level2">
<h2>6. 弱情報事前分布の設定</h2>
<ul>
<li>パラメータの範囲が”ある程度”分かっているとき</li>
<li>“やや狭い”事前分布
<ul>
<li>例えば-5から5が想定されるとして、
<ul>
<li>uniform(-5, 5)のように範囲が厳格に決まった一様分布よりも</li>
<li>normal(0, 5)のような緩やかに範囲が決められる決め方が良い
<ul>
<li>t分布が使われたりもする</li>
<li>Prior Choice Recommendations参照</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="対数密度加算文" class="section level2">
<h2>7. 対数密度加算文</h2>
<ul>
<li>サンプリング文は対数密度加算文という形式でも実装可能</li>
<li>例えばmu, sigmaに従う正規分布にしたがって得られるデータ</li>
<li>対数密度加算文では
<ul>
<li>model{ for (i in 1:N) target += normal_lpdf(sales[i]|mu, sigma); }</li>
</ul></li>
<li>targetに対して対数確率密度関数(log probability density function)を加算してるということ
<ul>
<li>離散型の場合、lpmf(log probability mass function)</li>
</ul></li>
<li>事前分布として広い正規分布を与える場合
<ul>
<li>model{ target += normal_lpdf(mu|0, 1000000); target += normal_lpdf(sigma|0, 1000000);
<ul>
<li>ここでtargetはlp__(対数事後確率) }</li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="平均値の差の評価とgenerated-quantitiesブロック" class="section level2">
<h2>8. 平均値の差の評価とgenerated quantitiesブロック</h2>
<ul>
<li>モデル推定とは独立に乱数を得たい</li>
</ul>
<pre class="r"><code>library(ggplot2)
library(rstan)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())
file_beer_sales_ab&lt;-read.csv(&quot;2-6-1-beer-sales-ab.csv&quot;)
ggplot(data=file_beer_sales_ab, mapping=aes(x=sales, y=..density.., color=beer_name, fill=beer_name))+geom_histogram(alpha=0.5,position=&quot;identity&quot;)+geom_density(alpha=0.5, size=0)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="baba2_files/figure-html/mcmc_result6-1.png" width="768" /></p>
<pre class="r"><code>sales_a&lt;-file_beer_sales_ab$sales[1:100]
sales_b&lt;-file_beer_sales_ab$sales[101:200]
data_list_ab&lt;-list(
  sales_a=sales_a,
  sales_b=sales_b,
  N=100
)

mcmc_result_6&lt;-stan(file=&quot;2-6-5-difference-mean.stan&quot;,
                    data=data_list_ab,
                    seed=1
)
print(mcmc_result_6, probs=c(0.025, 0.5, .0975))</code></pre>
<pre><code>## Inference for Stan model: 2-6-5-difference-mean.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##            mean se_mean   sd    2.5%     50%   9.75% n_eff Rhat
## mu_a     102.22    0.03 1.84   98.64  102.22   99.89  4352    1
## sigma_a   18.19    0.02 1.30   15.84   18.12   16.58  3742    1
## mu_b     168.88    0.05 2.92  163.14  168.91  165.15  3627    1
## sigma_b   29.11    0.03 2.09   25.37   28.96   26.47  4374    1
## diff      66.66    0.05 3.50   59.84   66.67   62.19  4094    1
## lp__    -719.42    0.03 1.45 -723.21 -719.07 -721.34  2249    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Jan 27 11:16:39 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
<div id="練習問題" class="section level2">
<h2>練習問題</h2>
<ul>
<li>異なる分散を仮定</li>
</ul>
<pre class="r"><code>library(rstan)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())
pdata&lt;-read.csv(&quot;data_if.csv&quot;)
xdata&lt;-pdata[which(pdata$con==&quot;X&quot;),]
ydata&lt;-pdata[which(pdata$con==&quot;Y&quot;),]
ggplot(data=pdata, mapping=aes(x=syakou, y=..density.., color=con, fill=con))+geom_histogram(alpha=0.5, position=&quot;identity&quot;)+geom_density(alpha=0.5, size=0)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="baba2_files/figure-html/prac1-1.png" width="768" /></p>
<pre class="r"><code>list_xy&lt;-list(datax=xdata[,2],datay=ydata[,2],Nx=length(xdata[,2]),Ny=length(ydata[,2]))
mcmc_p_res &lt;- stan(file=&quot;2-6-5-pdata.stan&quot;,
                   data=list_xy,
                   seed=1
)
print(mcmc_p_res)</code></pre>
<pre><code>## Inference for Stan model: 2-6-5-pdata.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##           mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## mu_x      5.19    0.00 0.24   4.73   5.03   5.19   5.35   5.66  3376    1
## sigma_x   1.24    0.00 0.18   0.93   1.11   1.22   1.34   1.65  3326    1
## mu_y      2.60    0.00 0.22   2.17   2.46   2.61   2.75   3.05  3890    1
## sigma_y   1.10    0.00 0.17   0.83   0.97   1.07   1.20   1.49  3012    1
## diff      2.58    0.01 0.32   1.94   2.37   2.58   2.80   3.22  3643    1
## lp__    -32.31    0.04 1.48 -35.98 -33.01 -31.98 -31.25 -30.48  1552    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Jan 27 11:16:54 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<pre class="r"><code>library(bayesplot)
mcmc_combo(mcmc_p_res, pars=c(&quot;mu_x&quot;, &quot;mu_y&quot;, &quot;sigma_x&quot;, &quot;sigma_y&quot;, &quot;diff&quot;))</code></pre>
<p><img src="baba2_files/figure-html/prac1-2.png" width="768" /></p>
<pre class="r"><code>stan_hist(mcmc_p_res)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="baba2_files/figure-html/prac1-3.png" width="768" /></p>
<ul>
<li>同じ分散を仮定</li>
</ul>
<pre class="r"><code>library(rstan)
library(ggplot2)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())
pdata&lt;-read.csv(&quot;data_if.csv&quot;)
xdata&lt;-pdata[which(pdata$con==&quot;X&quot;),]
ydata&lt;-pdata[which(pdata$con==&quot;Y&quot;),]

ggplot(data=pdata, mapping=aes(x=syakou, y=..density.., color=con, fill=con))+geom_histogram(alpha=0.5, position=&quot;identity&quot;)+geom_density(alpha=0.5, size=0)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="baba2_files/figure-html/prac2-1.png" width="768" /></p>
<pre class="r"><code>list_xy&lt;-list(datax=xdata[,2],datay=ydata[,2],Nx=length(xdata[,2]),Ny=length(ydata[,2]))

mcmc_p_res &lt;- stan(file=&quot;2-6-5-pdata2.stan&quot;,
                   data=list_xy,
                   seed=1
)
print(mcmc_p_res)</code></pre>
<pre><code>## Inference for Stan model: 2-6-5-pdata2.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##         mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## mu_x    5.18    0.00 0.22   4.75   5.04   5.18   5.33   5.60  3458    1
## sigma   1.15    0.00 0.12   0.94   1.06   1.13   1.22   1.41  3170    1
## mu_y    2.60    0.00 0.23   2.14   2.45   2.60   2.76   3.06  3492    1
## diff    2.58    0.01 0.32   1.94   2.37   2.58   2.79   3.19  3575    1
## lp__  -32.07    0.03 1.26 -35.38 -32.66 -31.74 -31.15 -30.63  1686    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Jan 27 11:17:10 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
</div>
</div>

   
   
              </div>
  </div>
  </div>
  </div>
   
      

  <script>
    $(document).ready(function () {

		// add bootstrap table styles to pandoc tables
	$('tr.header').parent('thead').parent('table').addClass('table table-condensed');
		
 		
	    });
  </script>



    <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
	document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>
  
</body>
</html>
