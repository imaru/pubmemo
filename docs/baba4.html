<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="pandoc" />

        <meta name="author" content="Toshihide Imaruoka" />
    
    
    <title>馬場本4</title>

        <script src="site_libs/header-attrs-2.23/header-attrs.js"></script>
        <script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="site_libs/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet" />
        <script src="site_libs/bootstrap-3.3.7/js/bootstrap.min.js"></script>
        <script src="site_libs/navigation-1.1/tabsets.js"></script>
        <link href="site_libs/downcute-0.1/downcute.css" rel="stylesheet" />
        <link href="site_libs/downcute-0.1/downcute_fonts_embed.css" rel="stylesheet" />
        <script src="site_libs/downcute-0.1/downcute_styles.js"></script>
        <script src="site_libs/downcute-0.1/downcute.js"></script>
        <script src="site_libs/prism-1.22/prism.js"></script>
    
    
    
        <link rel="stylesheet" href="mycss.css" type="text/css" />
    
    <!-- tabsets -->
    <script>
      $(document).ready(function () {
	  window.buildTabsets("toc");
      });
      $(document).ready(function () {
	  $('.tabset-dropdown > .nav-tabs > li').click(function () {
	      $(this).parent().toggleClass('nav-tabs-open')
	  });
      });
    </script>

    <!-- code folding -->
    
    <!-- code download -->
    
    <!-- tabsets dropdown -->

    <style type="text/css">
      .tabset-dropdown > .nav-tabs {
	  display: inline-table;
	  max-height: 500px;
	  min-height: 44px;
	  overflow-y: auto;
	  background: white;
	  border: 1px solid #ddd;
	  border-radius: 4px;
      }
      
      .tabset-dropdown > .nav-tabs > li.active:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
	  content: "&#xe258;";
	  border: none;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs > li.active {
	  display: block;
      }

      .tabset-dropdown > .nav-tabs > li.active a {
  	  padding: 0 15px !important;
      }

      .tabset-dropdown > .nav-tabs > li > a,
      .tabset-dropdown > .nav-tabs > li > a:focus,
      .tabset-dropdown > .nav-tabs > li > a:hover {
	  border: none;
	  display: inline-block;
	  border-radius: 4px;
	  background-color: transparent;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li {
	  display: block;
	  float: none;
      }
      
      .tabset-dropdown > .nav-tabs > li {
	  display: none;
	  margin-left: 0 !important;
      }
    </style>
    
</head>

<body class="preload">

   	
               <!-- downcute start -->   
   <div id="docute" class="Root theme-default">
     <div class="Page layout-narrow">
      <div class="Wrap">
        <div class="Sidebar">
          <div class="SidebarItems" id="toc">
            <ul>
            <li><a href="#部-一般化線形混合モデル"
            id="toc-部-一般化線形混合モデル">4部:
            一般化線形混合モデル</a></li>
            <li><a href="#階層ベイズモデルと一般化線形混合モデルの基本"
            id="toc-階層ベイズモデルと一般化線形混合モデルの基本">4-1:
            階層ベイズモデルと一般化線形混合モデルの基本</a>
            <ul>
            <li><a href="#本章の目的と概要" id="toc-本章の目的と概要">1.
            本章の目的と概要</a></li>
            <li><a href="#階層ベイズモデル" id="toc-階層ベイズモデル">2.
            階層ベイズモデル</a></li>
            <li><a href="#分析の準備" id="toc-分析の準備">3.
            分析の準備</a></li>
            <li><a href="#通常のポアソン回帰モデルを適用した結果"
            id="toc-通常のポアソン回帰モデルを適用した結果">4.
            通常のポアソン回帰モデルを適用した結果</a></li>
            <li><a href="#過分散対処のあためのglmmの構造"
            id="toc-過分散対処のあためのglmmの構造">5.
            過分散対処のあためのGLMMの構造</a></li>
            <li><a href="#固定効果ランダム効果混合モデル"
            id="toc-固定効果ランダム効果混合モデル">6.
            固定効果・ランダム効果・混合モデル</a></li>
            <li><a href="#モデルの構造の図式化"
            id="toc-モデルの構造の図式化">7.
            モデルの構造の図式化</a></li>
            <li><a href="#glmmのためのstanファイルの実装"
            id="toc-glmmのためのstanファイルの実装">8.
            GLMMのためのStanファイルの実装</a></li>
            <li><a href="#mcmcの実行" id="toc-mcmcの実行">9.
            MCMCの実行</a></li>
            <li><a href="#brmsによるglmmの推定"
            id="toc-brmsによるglmmの推定">10.
            brmsによるGLMMの推定</a></li>
            <li><a href="#補足正規線形モデルを拡張する場合の注意"
            id="toc-補足正規線形モデルを拡張する場合の注意">11.
            補足：正規線形モデルを拡張する場合の注意</a></li>
            </ul></li>
            <li><a href="#ランダム切片モデル"
            id="toc-ランダム切片モデル">4-2: ランダム切片モデル</a>
            <ul>
            <li><a href="#分析の準備-1" id="toc-分析の準備-1">2.
            分析の準備</a></li>
            <li><a href="#ランダム切片モデルの構造"
            id="toc-ランダム切片モデルの構造">3.
            ランダム切片モデルの構造</a></li>
            <li><a href="#ランダム効果の使いどころ"
            id="toc-ランダム効果の使いどころ">4.
            ランダム効果の使いどころ</a></li>
            <li><a href="#brmsによるランダム切片モデルの推定"
            id="toc-brmsによるランダム切片モデルの推定">5.
            brmsによるランダム切片モデルの推定</a></li>
            <li><a href="#回帰曲線の図示" id="toc-回帰曲線の図示">6.
            回帰曲線の図示</a></li>
            </ul></li>
            <li><a href="#ランダム係数モデル"
            id="toc-ランダム係数モデル">4-3: ランダム係数モデル</a>
            <ul>
            <li><a href="#本章の目的と概要-1"
            id="toc-本章の目的と概要-1">1. 本章の目的と概要</a></li>
            <li><a href="#分析の準備-2" id="toc-分析の準備-2">2.
            分析の準備</a></li>
            <li><a href="#交互作用を用いたモデル化"
            id="toc-交互作用を用いたモデル化">3.
            交互作用を用いたモデル化</a></li>
            <li><a href="#ランダム効果と縮約"
            id="toc-ランダム効果と縮約">4. ランダム効果と縮約</a></li>
            <li><a href="#ランダム係数モデルの構造"
            id="toc-ランダム係数モデルの構造">5.
            ランダム係数モデルの構造</a></li>
            <li><a href="#brmsによるランダム係数モデルの推定"
            id="toc-brmsによるランダム係数モデルの推定">6.
            brmsによるランダム係数モデルの推定</a></li>
            <li><a href="#回帰曲線の図示-1" id="toc-回帰曲線の図示-1">7.
            回帰曲線の図示</a></li>
            <li><a href="#ランダム効果を用いるさまざまなモデル"
            id="toc-ランダム効果を用いるさまざまなモデル">8.
            ランダム効果を用いるさまざまなモデル</a></li>
            </ul></li>
            </ul>
          </div>
          <div data-position="sidebar:post-end" class="InjectedComponents"><div class="dark-theme-toggler"><div class="toggle "><div class="toggle-track"><div class="toggle-track-check"><img  src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16"></div> <div class="toggle-track-x"><img src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16"></div></div> <div class="toggle-thumb"></div></div> <input type="checkbox" aria-label="Switch between Dark and Default theme" class="toggler-screen-reader-only"></div></div>
        </div>
        <div class="Main">
          <div class="Content" id="content"> 
   
   
      
      <div class="navbar navbar-default  navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">my public memo</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li>
        <a href="index.html">Home</a>
      </li>
      <li>
        <a href="midori1.html">緑本</a>
      </li>
      <li>
        <a href="baba1.html">馬場本1部</a>
      </li>
      <li>
        <a href="baba2.html">馬場本2部</a>
      </li>
      <li>
        <a href="baba3.html">馬場本3部</a>
      </li>
      <li>
        <a href="baba4.html">馬場本4部</a>
      </li>
      <li>
        <a href="psytech.html">技術部</a>
      </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              
            </ul>
          </div><!--/.nav-collapse -->
        </div><!--/.container -->
      </div><!--/.navbar -->
        
      <h1 class="title">馬場本4</h1>
      
      <p class="authors">
           <span class="glyphicon glyphicon-user"></span> Toshihide
Imaruoka
      </p>
              

   
      
   
<!-- Don't indent these lines or it will mess pre blocks indentation --> 
<div class="page-content has-page-title">
<div id="部-一般化線形混合モデル" class="section level1">
<h1>4部: 一般化線形混合モデル</h1>
</div>
<div id="階層ベイズモデルと一般化線形混合モデルの基本"
class="section level1">
<h1>4-1: 階層ベイズモデルと一般化線形混合モデルの基本</h1>
<div id="本章の目的と概要" class="section level2">
<h2>1. 本章の目的と概要</h2>
<ul>
<li>階層ベイズモデル
<ul>
<li>過分散が生じているデータ</li>
<li>一般化線形混合モデル(GLMM)</li>
</ul></li>
<li>過分散への対応と高度なモデルの使用</li>
</ul>
</div>
<div id="階層ベイズモデル" class="section level2">
<h2>2. 階層ベイズモデル</h2>
<ul>
<li>階層構造を持つモデル</li>
<li>上位層の確率変数の実現値が階層の分布のパラメータとなる</li>
<li>さまざまなモデルで階層を想定可能
<ul>
<li>一般化線形混合モデル</li>
<li>状態空間モデル</li>
</ul></li>
</ul>
</div>
<div id="分析の準備" class="section level2">
<h2>3. 分析の準備</h2>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())

dat41&lt;-read.csv(&#39;4-1-1-fish-num-2.csv&#39;)
dat41$id&lt;-as.factor(dat41$id)
head(dat41, n=3)</code></pre>
<pre><code>##   fish_num weather temperature id
## 1        0  cloudy         5.0  1
## 2        1  cloudy        24.2  2
## 3        6  cloudy        11.5  3</code></pre>
<ul>
<li>id列：釣り人id。idが違うと人、環境が変わっている可能性がある。これをモデルに組み込みたいという話。</li>
</ul>
</div>
<div id="通常のポアソン回帰モデルを適用した結果" class="section level2">
<h2>4. 通常のポアソン回帰モデルを適用した結果</h2>
<pre class="r"><code>brms41_1&lt;-brm(
  formula=fish_num~weather+temperature,
  family=poisson(),
  data=dat41,
  seed=1,
  prior=NULL
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>eff41_1&lt;-conditional_effects(brms41_1, method=&#39;predict&#39;, effects=&#39;temperature:weather&#39;,
                             prob=0.99)
plot(eff41_1, points=T)</code></pre>
<p><img src="baba4_files/figure-html/unnamed-chunk-2-1.png" width="768" /></p>
<ul>
<li>本のコードでは95%予測区間になってそうだけど、上のは99%。そこからデータが出てしまうのは良くない＝モデルがデータに合ってない</li>
</ul>
</div>
<div id="過分散対処のあためのglmmの構造" class="section level2">
<h2>5. 過分散対処のあためのGLMMの構造</h2>
<ul>
<li>基本は同じ</li>
<li>釣果数に気温と天気が影響する
<ul>
<li><span
class="math inline">\(log(\lambda_i)=\beta_0+\beta_1x_1+\beta_2x_2\)</span></li>
</ul></li>
<li>ただし、調査対象者の違い、湖の状況の違いも影響するのでそれをモデルに入れる
<ul>
<li>ランダムな影響<span class="math inline">\(r_i\)</span>
<ul>
<li>平均0, 分散<span class="math inline">\(\sigma_\gamma^2\)</span></li>
<li><span class="math inline">\(\gamma_i\sim Normal(0,
\sigma_r^2)\)</span></li>
<li><span
class="math inline">\(log(\lambda_i)=\beta_0+\beta_1x_1+\beta_2x_2+r_i\)</span></li>
<li><span class="math inline">\(y_i\sim Poiss(\lambda_i)\)</span></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="固定効果ランダム効果混合モデル" class="section level2">
<h2>6. 固定効果・ランダム効果・混合モデル</h2>
<ul>
<li>用語
<ul>
<li><span
class="math inline">\(\beta\)</span>で表現された係数として表される効果：固定効果</li>
<li>何らかの確率分布に従い、ランダムに変化する係数：ランダム効果・変量効果</li>
<li>固定効果とランダム効果を両方持つモデル：混合モデル</li>
</ul></li>
<li>緑本P154
<ul>
<li>固定効果：全体の平均に影響</li>
<li>ランダム効果：全体のばたつきは変えるが、平均には影響しない</li>
</ul></li>
</ul>
</div>
<div id="モデルの構造の図式化" class="section level2">
<h2>7. モデルの構造の図式化</h2>
<ul>
<li>確率分布が階層的になっていることを階層モデルと呼ぶ、ということらしい
<ul>
<li>まあ、それはそうか</li>
</ul></li>
</ul>
</div>
<div id="glmmのためのstanファイルの実装" class="section level2">
<h2>8. GLMMのためのStanファイルの実装</h2>
<ul>
<li>まずはStanでの実装から</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int fish_num[N];
  vector[N] sunny;
  vector[N] temp;
}
parameters{
  real Intercept;
  real b_temp;
  real b_sunny;
  vector[N] r;
  real&lt;lower=0&gt; sigma_r;
}
transformed parameters{
  vector[N] lambda = Intercept + b_sunny*sunny + b_temp*temp + r;
}
model{
  r ~ normal(0, sigma_r);
  fish_num ~ poisson_log(lambda);
}</code></pre>
<ul>
<li>transformed
parameters内の式は線形予測子。おそらく、これは右辺をexp()に入れてもいいはずだけど、モデルでpoisson_log関数を使ってるので、そうしてないだけ。</li>
<li>modelブロックないの<span class="math inline">\(r\sim normal(0,
sigma_r)\)</span>は事前分布の指定っぽいんだけど、sigma_rが変数なので分散はどうなる？参照先である2部6章では10000のような数値を入れていたけど。
<ul>
<li>合点がいった。sigma_rも推定対象なのか。ランダム効果の大きさを表すパラメータとのこと。
<ul>
<li>ちょっと理解できない感じは残ってる</li>
</ul></li>
</ul></li>
<li>とにかく、sigma_rはパラメータ（r）のパラメータなので超パラメータあるいはハイパーパラメータと呼ぶらしい。</li>
</ul>
</div>
<div id="mcmcの実行" class="section level2">
<h2>9. MCMCの実行</h2>
<pre class="r"><code>formula41&lt;-formula(fish_num ~ weather + temperature)
mtx41&lt;-model.matrix(formula41, dat41)
sunny_dummy&lt;-as.numeric(mtx41[,&#39;weathersunny&#39;])

data_list41&lt;-list(
  N=nrow(dat41),
  fish_num=dat41$fish_num,
  temp=dat41$temperature,
  sunny=sunny_dummy
)

res41&lt;-rstan::sampling(stanmodel41_1, data=data_list41, seed=1)
print(res41, pars=c(&#39;Intercept&#39;,&#39;b_sunny&#39;,&#39;b_temp&#39;,&#39;sigma_r&#39;), probs=c(0.025,0.5,0.975))</code></pre>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##            mean se_mean   sd  2.5%   50% 97.5% n_eff Rhat
## Intercept -0.45    0.01 0.34 -1.16 -0.43  0.17   872    1
## b_sunny   -0.74    0.01 0.29 -1.30 -0.73 -0.18  1153    1
## b_temp     0.08    0.00 0.02  0.04  0.08  0.11   847    1
## sigma_r    1.09    0.01 0.15  0.83  1.08  1.42   866    1
## 
## Samples were drawn using NUTS(diag_e) at Tue Jul 11 18:38:46 2023.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
<div id="brmsによるglmmの推定" class="section level2">
<h2>10. brmsによるGLMMの推定</h2>
<ul>
<li>brmsによる推定</li>
</ul>
<pre class="r"><code>brms41&lt;-brm(
  formula=fish_num~weather+temperature+(1|id),
  family=poisson(),
  data=dat41,
  seed=1,
  prior=NULL
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>brms41</code></pre>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: fish_num ~ weather + temperature + (1 | id) 
##    Data: dat41 (Number of observations: 100) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Group-Level Effects: 
## ~id (Number of levels: 100) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.09      0.15     0.83     1.41 1.00     1194     2055
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept       -0.47      0.35    -1.19     0.17 1.00     1567     1832
## weathersunny    -0.72      0.30    -1.30    -0.16 1.01     1224     1721
## temperature      0.08      0.02     0.04     0.11 1.00     1371     1990
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<ul>
<li>formulaの最終項 (1|id) がランダム効果。1は切片。idがグループ名。
<ul>
<li>ここでは対象者ごとに個別のグループということ？</li>
</ul></li>
<li>Group-Level Effectがランダム効果</li>
</ul>
</div>
<div id="補足正規線形モデルを拡張する場合の注意" class="section level2">
<h2>11. 補足：正規線形モデルを拡張する場合の注意</h2>
<ul>
<li>今と同じ考え方で正規線形モデルにランダム効果を入れては行けない。</li>
<li>期待値と分散が違うパラメータだから</li>
<li>でも、そもそも個体差みたいなものが無視された計測だったら入れてもいいのでは？</li>
</ul>
</div>
</div>
<div id="ランダム切片モデル" class="section level1">
<h1>4-2: ランダム切片モデル</h1>
<div id="分析の準備-1" class="section level2">
<h2>2. 分析の準備</h2>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())

dat42&lt;-read.csv(&#39;4-2-1-fish-num-3.csv&#39;)
summary(dat42)</code></pre>
<pre><code>##     fish_num       weather           temperature       human          
##  Min.   : 0.00   Length:100         Min.   : 0.40   Length:100        
##  1st Qu.: 0.00   Class :character   1st Qu.: 7.55   Class :character  
##  Median : 1.50   Mode  :character   Median :14.65   Mode  :character  
##  Mean   : 2.48                      Mean   :15.55                     
##  3rd Qu.: 4.00                      3rd Qu.:24.55                     
##  Max.   :15.00                      Max.   :29.70</code></pre>
</div>
<div id="ランダム切片モデルの構造" class="section level2">
<h2>3. ランダム切片モデルの構造</h2>
<ul>
<li>基本はさっきと同じ</li>
<li><span class="math inline">\(r_k\)</span>: kはAからJまで10種類</li>
<li>平均0、分散<span
class="math inline">\(\sigma_r^2\)</span>の正規分布に従う</li>
<li><span class="math inline">\(r_k\sim Normal(0,
\sigma_r)\)</span></li>
<li><span
class="math inline">\(log(\lambda_i)=\$beta_0+\beta_1x_1+\beta_2x_2+r_k\)</span></li>
<li><span class="math inline">\(y_i\sim Poiss(\lambda_i)\)</span></li>
</ul>
</div>
<div id="ランダム効果の使いどころ" class="section level2">
<h2>4. ランダム効果の使いどころ</h2>
<ul>
<li>固定効果とする必要がない場合＝興味ある効果ではない</li>
<li>データに含まれる疑似反復を防ぐ＝反復測定？</li>
</ul>
</div>
<div id="brmsによるランダム切片モデルの推定" class="section level2">
<h2>5. brmsによるランダム切片モデルの推定</h2>
<pre class="r"><code>brms42&lt;-brm(
  formula=fish_num~weather+temperature+(1|human),
  family=poisson(),
  data=dat42,
  seed=1,
  prior=NULL
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>brms42</code></pre>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: fish_num ~ weather + temperature + (1 | human) 
##    Data: dat42 (Number of observations: 100) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Group-Level Effects: 
## ~human (Number of levels: 10) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.64      0.21     0.36     1.16 1.00      968     1552
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept       -0.87      0.30    -1.50    -0.33 1.00     1460     1779
## weathersunny    -0.52      0.13    -0.78    -0.27 1.00     3285     2715
## temperature      0.10      0.01     0.08     0.12 1.00     3579     2844
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>ranef(brms42)</code></pre>
<pre><code>## $human
## , , Intercept
## 
##      Estimate Est.Error        Q2.5       Q97.5
## A  0.76119706 0.2549181  0.29351583  1.30733330
## B  0.08231762 0.2949582 -0.48398853  0.69671198
## C  0.69018425 0.2614803  0.19675755  1.25110619
## D -0.61284528 0.3400910 -1.31294558  0.02928462
## E -0.12204142 0.2966121 -0.68973010  0.47643906
## F -0.73766277 0.3559530 -1.48944447 -0.08173294
## G  0.44693932 0.2726351 -0.06752996  1.01478231
## H -0.32342412 0.2945592 -0.89942839  0.26573070
## I  0.02266429 0.2840992 -0.53837630  0.58994563
## J -0.16810624 0.2960147 -0.75550891  0.40990438</code></pre>
</div>
<div id="回帰曲線の図示" class="section level2">
<h2>6. 回帰曲線の図示</h2>
<pre class="r"><code>eff&lt;-conditional_effects(brms42, effects=&#39;temperature:weather&#39;)
plot(eff, points=T)</code></pre>
<p><img src="baba4_files/figure-html/unnamed-chunk-7-1.png" width="768" /></p>
<ul>
<li>個別のグラフは本参照のこと</li>
</ul>
</div>
</div>
<div id="ランダム係数モデル" class="section level1">
<h1>4-3: ランダム係数モデル</h1>
<div id="本章の目的と概要-1" class="section level2">
<h2>1. 本章の目的と概要</h2>
<ul>
<li>係数に対してランダム効果を加える</li>
</ul>
</div>
<div id="分析の準備-2" class="section level2">
<h2>2. 分析の準備</h2>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())

dat43&lt;-read.csv(&#39;4-3-1-fish-num-4.csv&#39;)
summary(dat43)</code></pre>
<pre><code>##     fish_num       temperature       human          
##  Min.   : 0.000   Min.   :10.10   Length:94         
##  1st Qu.: 4.000   1st Qu.:13.22   Class :character  
##  Median : 7.000   Median :14.85   Mode  :character  
##  Mean   : 8.787   Mean   :15.13                     
##  3rd Qu.:11.000   3rd Qu.:17.52                     
##  Max.   :29.000   Max.   :19.90</code></pre>
<ul>
<li>human J のみデータが少ない</li>
</ul>
</div>
<div id="交互作用を用いたモデル化" class="section level2">
<h2>3. 交互作用を用いたモデル化</h2>
<ul>
<li>temperatureの効果は人によって異なる、というモデル</li>
</ul>
<pre class="r"><code>brms43_ia&lt;-brm(
  formula=fish_num~temperature*human,
  family=poisson(),
  data=dat43,
  seed=1,
  prior=NULL
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>conditions&lt;-data.frame(human=c(&#39;A&#39;,&#39;B&#39;,&#39;C&#39;,&#39;D&#39;,&#39;E&#39;,&#39;F&#39;,&#39;G&#39;,&#39;H&#39;,&#39;I&#39;,&#39;J&#39;))
eff&lt;-conditional_effects(brms43_ia, effects=&#39;temperature&#39;, conditions=conditions)
plot(eff, points=T)</code></pre>
<p><img src="baba4_files/figure-html/unnamed-chunk-9-1.png" width="768" /></p>
<ul>
<li>10番の結果のみ右下がりの効果
<ul>
<li>観測回数が少ないことによる誤ったモデル化</li>
</ul></li>
</ul>
</div>
<div id="ランダム効果と縮約" class="section level2">
<h2>4. ランダム効果と縮約</h2>
<ul>
<li>全体の効果をランダム効果を受けた効果に持ち込む＝縮約</li>
</ul>
</div>
<div id="ランダム係数モデルの構造" class="section level2">
<h2>5. ランダム係数モデルの構造</h2>
<ul>
<li>ランダム切片とランダム係数をどちらもモデルに入れる</li>
<li><span class="math inline">\(\gamma_k\sim Normal(0,
\sigma_\gamma^2)\)</span></li>
<li><span class="math inline">\(\tau_k\sim Normal(0,
\sigma_\tau^2)\)</span></li>
<li><span class="math inline">\(log(\lambda_i)\sim \beta_0 +
(\beta_1+\tau_k)x_{i1}+\gamma_k\)</span></li>
<li><span class="math inline">\(y_i\sim Poiss(\lambda_i)\)</span></li>
</ul>
</div>
<div id="brmsによるランダム係数モデルの推定" class="section level2">
<h2>6. brmsによるランダム係数モデルの推定</h2>
<pre class="r"><code>brms43_re&lt;-brm(
  formula=fish_num~temperature+(temperature||human),
  family=poisson(),
  data=dat43,
  seed=1,
  prior=NULL,
  iter=8000,
  warmup=5000,
  control=list(adapt_delta=0.98, max_treedepth=15)
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre><code>## Warning: There were 1 divergent transitions after warmup. See
## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
## to find out why this is a problem and how to eliminate them.</code></pre>
<pre><code>## Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<ul>
<li>本のままのパラメータでは警告
<ul>
<li>iter=8000, adapt_delta=0.98 だと大丈夫</li>
<li>結果はそれほど変わらない？</li>
</ul></li>
<li>formulaの右辺、temperature||humanをtemperature|humanとすると、ランダム切片とランダム係数の間の相関を認めたモデルとなる。</li>
</ul>
</div>
<div id="回帰曲線の図示-1" class="section level2">
<h2>7. 回帰曲線の図示</h2>
<ul>
<li>10番の曲線も右上がりとなる。縮約の効果。</li>
</ul>
</div>
<div id="ランダム効果を用いるさまざまなモデル" class="section level2">
<h2>8. ランダム効果を用いるさまざまなモデル</h2>
<ul>
<li>ポアソン回帰だけじゃなくて、正規線形モデルやロジスティック回帰モデルでも可能</li>
</ul>
</div>
</div>
</div>

   
   
              </div>
  </div>
  </div>
  </div>
   
      

  <script>
    $(document).ready(function () {

		// add bootstrap table styles to pandoc tables
	$('tr.header').parent('thead').parent('table').addClass('table table-condensed');
		
 		
	    });
  </script>



    <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
	document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>
  
</body>
</html>
